From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hopeless-ponderer <hopelessponderer1123@gmail.com>
Date: Wed, 9 Jun 2021 21:59:41 -0700
Subject: [PATCH] removed debugs from setup-parent.sh and added handling for
 cases where an existing repository isn't deep enough

---
 binaries/data/mods/public/dev/setup-parent.sh | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/binaries/data/mods/public/dev/setup-parent.sh b/binaries/data/mods/public/dev/setup-parent.sh
index a32bd9231b..77668e3b86 100755
--- a/binaries/data/mods/public/dev/setup-parent.sh
+++ b/binaries/data/mods/public/dev/setup-parent.sh
@@ -31,16 +31,23 @@ fi
 # clone 0ad repo into parent dir if it doesn't already exist
 if [[ ! -d "${parent_dir}" ]]; then
 	echo "git base date: ${git_base_date}" >&2
-	# TODO: remove debug
-	echo git clone command: git clone $(if [[ ${git_base_date} ]]; then echo --shallow-since="${git_base_date}"; elif [[ "${git_base}" = 'master' ]]; then echo --depth=1; fi) "${oad_git_server}" "${parent_dir}"
 	git clone $(if [[ ${git_base_date} ]]; then echo --shallow-since="${git_base_date}"; elif [[ "${git_base}" = 'master' ]]; then echo --depth=1; fi) "${oad_git_server}" "${parent_dir}"
 fi
 
+if [[ ! -d "${parent_dir}" ]]; then
+	echo "ERROR: could not set up parent dir ${parent_dir}" >&2
+	exit 1
+fi
+
 # setup new branch, save latest master commit to child dir dev files
 cd "${parent_dir}"
 # set git_base to exact commit hash
 git_base="$(grep -m 1 -o -e '^commit \S\+' < "${git_base_file}" | cut -c8-)"
 git switch master
+# fetch commit in question if not present
+if ! git log -n 1 --output=/dev/null "${git_base}"; then
+	git fetch --shallow-since="${git_base_date}"
+fi
 git checkout "${git_base}"
 git switch -c "${OAD_MOD_NAME}"
 
-- 
2.25.1

