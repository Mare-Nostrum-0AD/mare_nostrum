From 2adc9483a24ea3721481d4e9a7e62585d4e8f362 Mon Sep 17 00:00:00 2001
From: hopeless-ponderer <hopelessponderer1123@gmail.com>
Date: Wed, 9 Jun 2021 00:11:25 -0700
Subject: [PATCH] final tweaks to setup-parent.sh

---
 binaries/data/mods/public/dev/parent/utils.sh |  2 +-
 binaries/data/mods/public/dev/setup-parent.sh | 10 ++++++----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/binaries/data/mods/public/dev/parent/utils.sh b/binaries/data/mods/public/dev/parent/utils.sh
index 0d652cd07c..bcd7c7bdfc 100644
--- a/binaries/data/mods/public/dev/parent/utils.sh
+++ b/binaries/data/mods/public/dev/parent/utils.sh
@@ -42,7 +42,7 @@ function sync_to_child() {
 	cd "${OAD_PARENT_DIR}"
 	rm -rf "${OAD_GIT_PATCH}"
 	git format-patch --no-numbered -o "${OAD_GIT_PATCH}" "$(git merge-base --fork-point master)"..HEAD -- binaries/data/mods/public
-	git log -n 1 --date=short "$(git merge-base --fork-point master)" > "${OAD_GIT_BASE_FILE}"
+	git log -n 1 --date=iso-strict "$(git merge-base --fork-point master)" > "${OAD_GIT_BASE_FILE}"
 	cd "${OAD_CHILD_DIR}"
 	git add ${moved_files[@]}
 	git add "${OAD_GIT_PATCH}"/*
diff --git a/binaries/data/mods/public/dev/setup-parent.sh b/binaries/data/mods/public/dev/setup-parent.sh
index 7fb6325a74..a32bd9231b 100755
--- a/binaries/data/mods/public/dev/setup-parent.sh
+++ b/binaries/data/mods/public/dev/setup-parent.sh
@@ -15,7 +15,7 @@ if [[ $2 ]]; then
 	git_base="$2"
 elif [[ -f "${git_base_file}" ]]; then
 	git_base="$(grep -m 1 -o -e '^commit \S\+' < "${git_base_file}" | cut -c8-)"
-	git_base_date="$(grep -m 1 -e '^Date: ' < "${git_base_file}" | sed -e 's#^Date:\s*##')"
+	git_base_date="$(date --date="@$(( $(date --date="$(grep -m 1 -e '^Date:' < "${git_base_file}" | sed -e 's#^Date:\s*##')" '+%s') - ( 3600 * 24 ) ))" '+%Y-%m-%d')"
 else
 	git_base='master'
 fi
@@ -30,12 +30,14 @@ fi
 
 # clone 0ad repo into parent dir if it doesn't already exist
 if [[ ! -d "${parent_dir}" ]]; then
-	git clone $([[ ${git_base_date} ]] && echo --shallow-since="${git_base_date}" || [[ "${git_base}" = 'master' ]] && echo --depth=1) "${oad_git_server}" "${parent_dir}"
+	echo "git base date: ${git_base_date}" >&2
+	# TODO: remove debug
+	echo git clone command: git clone $(if [[ ${git_base_date} ]]; then echo --shallow-since="${git_base_date}"; elif [[ "${git_base}" = 'master' ]]; then echo --depth=1; fi) "${oad_git_server}" "${parent_dir}"
+	git clone $(if [[ ${git_base_date} ]]; then echo --shallow-since="${git_base_date}"; elif [[ "${git_base}" = 'master' ]]; then echo --depth=1; fi) "${oad_git_server}" "${parent_dir}"
 fi
 
 # setup new branch, save latest master commit to child dir dev files
 cd "${parent_dir}"
-git log -n 1 --date=short "${git_base}" > "${git_base_file}"
 # set git_base to exact commit hash
 git_base="$(grep -m 1 -o -e '^commit \S\+' < "${git_base_file}" | cut -c8-)"
 git switch master
@@ -43,7 +45,7 @@ git checkout "${git_base}"
 git switch -c "${OAD_MOD_NAME}"
 
 # apply patch if it exists, else port all files individually
-if [[ -f "${oad_git_patch}" ]]; then
+if [[ -d "${oad_git_patch}" ]]; then
 	git am --ignore-whitespace "${oad_git_patch}"/*
 else
 	cd "${child_dir}"
-- 
2.25.1

